name: Security

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  schedule:
    - cron: "0 0 * * 1"
  workflow_dispatch:

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Detect which files changed - skip non-CodeQL scans if irrelevant
  # ============================================================================
  changes:
    runs-on: ubuntu-latest
    outputs:
      security_relevant: ${{ steps.result.outputs.security_relevant }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if explicit trigger
        id: explicit
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] || \
             [ "${{ github.event_name }}" = "schedule" ]; then
            echo "is_explicit=true" >> $GITHUB_OUTPUT
          else
            echo "is_explicit=false" >> $GITHUB_OUTPUT
          fi

      - uses: dorny/paths-filter@v3
        id: filter
        if: steps.explicit.outputs.is_explicit == 'false'
        with:
          filters: |
            security_relevant:
              - '**.ts'
              - '**.tsx'
              - '**.js'
              - '**.mjs'
              - '**/package*.json'

      - name: Determine if scans should run
        id: result
        run: |
          if [ "${{ steps.explicit.outputs.is_explicit }}" = "true" ]; then
            echo "security_relevant=true" >> $GITHUB_OUTPUT
          else
            echo "security_relevant=${{ steps.filter.outputs.security_relevant }}" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # CodeQL - Static Application Security Testing
  # ============================================================================
  codeql:
    name: CodeQL
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      security-events: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: security-extended
          config-file: ./.github/codeql/codeql-config.yml

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"

  # ============================================================================
  # Secret Scanning with Gitleaks
  # ============================================================================
  secret-scan:
    name: Secret Scan
    needs: changes
    if: needs.changes.outputs.security_relevant == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Gitleaks
        run: |
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.21.2/gitleaks_8.21.2_linux_x64.tar.gz | tar xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run Gitleaks
        run: gitleaks detect --source . --verbose --redact

  # ============================================================================
  # Dependency Scanning
  # ============================================================================
  dependency-scan:
    name: Dependency Scan
    needs: changes
    if: needs.changes.outputs.security_relevant == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate

  # ============================================================================
  # Security Status - Aggregates all security job results
  # ============================================================================
  security-status:
    name: Security Status
    runs-on: ubuntu-latest
    needs: [changes, codeql, secret-scan, dependency-scan]
    if: always()
    steps:
      - name: Check security scan results
        run: |
          echo "=== Security Scan Results ==="
          echo "Security-relevant files changed: ${{ needs.changes.outputs.security_relevant }}"
          echo "CodeQL: ${{ needs.codeql.result }}"
          echo "Secret Scan: ${{ needs.secret-scan.result }}"
          echo "Dependency Scan: ${{ needs.dependency-scan.result }}"
          echo ""

          if [ "${{ needs.codeql.result }}" = "failure" ] || [ "${{ needs.codeql.result }}" = "cancelled" ]; then
            echo "::error::CodeQL scan failed"
            exit 1
          fi

          if [ "${{ needs.changes.outputs.security_relevant }}" != "true" ]; then
            echo "✅ CodeQL passed, other scans skipped (no security-relevant files)"
            exit 0
          fi

          results="${{ needs.secret-scan.result }} ${{ needs.dependency-scan.result }}"
          if echo "$results" | grep -qE '(failure|cancelled)'; then
            echo "::error::One or more security scans failed"
            exit 1
          fi

          echo "✅ All security scans passed"
